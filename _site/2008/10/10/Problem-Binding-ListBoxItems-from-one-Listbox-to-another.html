<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Problem Binding ListBoxItems from one Listbox to another</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>Problem Binding ListBoxItems from one Listbox to another</h2>
<p class="meta">10 Oct 2008</p>

<div class="post">
<p>The following XAML was posted online at MSDN.    <br /><span style="color: blue">&lt;</span><span style="color: #a31515">StackPanel </span><span style="color: red">Orientation</span><span style="color: blue">=&quot;Vertical&quot; </span><span style="color: red">Name</span><span style="color: blue">=&quot;sp&quot;&gt;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">ListBox </span><span style="color: red">Name</span><span style="color: blue">=&quot;lb1&quot; </span><span style="color: red">Width</span><span style="color: blue">=&quot;200&quot; </span><span style="color: red">Height</span><span style="color: blue">=&quot;200&quot; </span><span style="color: red">SelectionMode</span><span style="color: blue">=&quot;Multiple&quot;&gt;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">ListBoxItem</span><span style="color: blue">&gt;</span><span style="color: #a31515">Item1</span><span style="color: blue">&lt;/</span><span style="color: #a31515">ListBoxItem</span><span style="color: blue">&gt;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">ListBoxItem</span><span style="color: blue">&gt;</span><span style="color: #a31515">Item5</span><span style="color: blue">&lt;/</span><span style="color: #a31515">ListBoxItem</span><span style="color: blue">&gt;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">ListBoxItem</span><span style="color: blue">&gt;</span><span style="color: #a31515">Item3</span><span style="color: blue">&lt;/</span><span style="color: #a31515">ListBoxItem</span><span style="color: blue">&gt;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">ListBoxItem</span><span style="color: blue">&gt;</span><span style="color: #a31515">Item2</span><span style="color: blue">&lt;/</span><span style="color: #a31515">ListBoxItem</span><span style="color: blue">&gt;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;/</span><span style="color: #a31515">ListBox</span><span style="color: blue">&gt;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">ListBox </span><span style="color: red">Name</span><span style="color: blue">=&quot;lb2&quot; </span><span style="color: red">Width</span><span style="color: blue">=&quot;200&quot; </span><span style="color: red">Height</span><span style="color: blue">=&quot;200&quot;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: red">ItemsSource</span><span style="color: blue">=&quot;{</span><span style="color: #a31515">Binding </span><span style="color: red">Path</span><span style="color: blue">=SelectedItems, </span><span style="color: red">ElementName</span><span style="color: blue">=lb1}&quot;&gt;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;/</span><span style="color: #a31515">ListBox</span><span style="color: blue">&gt;      <br />&lt;/</span><span style="color: #a31515">StackPanel</span><span style="color: blue">&gt;</span></p> <a href="http://11011.net/software/vspaste"></a>  <p>This means that when user selects an item from Listbox1, they should appear in listbox 2. But what happens you select Listbox1 is that the items disappear from Listbox1 and appear in Listbox2. The items go missing altogether! The screenshots of the behavior as well as the visual tree dumps to prove this is shown below.    <br /><strong>Initially after the XAML load      <br /></strong><a href="http://lh4.ggpht.com/krishbhargava/SO-cWcCjoLI/AAAAAAAAAtQ/fflEq5JigyY/s1600-h/image%5B30%5D.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="484" alt="image" src="http://lh3.ggpht.com/krishbhargava/SO-cXNtvn1I/AAAAAAAAAtU/AuE3KLiouJM/image_thumb%5B23%5D.png?imgmax=800" width="638" border="0" /></a>     <br /><strong>After selecting two items      <br /></strong><a href="http://lh4.ggpht.com/krishbhargava/SO-cXZsXZnI/AAAAAAAAAtY/5GqkywSPcJY/s1600-h/image%5B34%5D.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="484" alt="image" src="http://lh6.ggpht.com/krishbhargava/SO-cXZLxViI/AAAAAAAAAtc/1bjmPnkp1Ps/image_thumb%5B25%5D.png?imgmax=800" width="638" border="0" /></a> <strong>&#160; <br /></strong>In case you are wondering about the tool I am using to run the XAML, it is called BuddiPad, my custom XAML tool which has small features like XAML error parsing, go-to-error line, loads Visual Tree, Loads Logical Trees, etc. The listbox on the top right with a whitish background is the Visual tree while the one below with a Teal like background is the Logical Tree.     <br />    <br />If you notice, selected items appear in lb2 (in image 2) disappear from the Visual Tree for the lb1 altogether. This happens only with the ListBoxItems as ItemsSource. But if the ItemsSource was bound to some other dependency property like &quot;Roles&quot; or &quot;Users&quot; or any other user defined props in the class, it does not break.     <br />    <br />The workaround is to&#160; create new ListBoxItem and copy content property. Create a Selected property which is a Dependency Property as shown.    <br /><font size="2"><font face="Consolas"><span style="color: blue">         <br />public </span><span style="color: #2b91af">IList </span>Selected        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">get </span>{ <span style="color: blue">return </span>(<span style="color: #2b91af">IList</span>)GetValue(SelectedProperty); }        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">set </span>{ SetValue(SelectedProperty, <span style="color: blue">value</span>); }        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }        <br />        <br />&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font size="2"><font face="Consolas"><span style="color: green">// Using a DependencyProperty as the backing store for MyProperty.&#160; This enables animation, styling, binding, etc...         <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue">public static readonly </span><span style="color: #2b91af">DependencyProperty </span>SelectedProperty =        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">DependencyProperty</span>.Register(<span style="color: #a31515">&quot;Selected&quot;</span>, <span style="color: blue">typeof</span>(<span style="color: #2b91af">IList</span>), <span style="color: blue">typeof</span>(<span style="color: #2b91af">Window1</span>), <span style="color: blue">new </span><span style="color: #2b91af">UIPropertyMetadata</span>(<span style="color: blue">null</span>));        <br /></font></font>    <br />The XAML is shown&#160; for reference.     <br /><font size="2"><font face="Consolas"><span style="color: blue">         <br />&lt;</span><span style="color: #a31515">StackPanel </span><span style="color: red">Orientation</span><span style="color: blue">=&quot;Vertical&quot; </span><span style="color: red">Name</span></font></font><font size="2"><font face="Consolas"><span style="color: blue">=&quot;sp&quot;&gt;         <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">ListBox </span><span style="color: red">x</span><span style="color: blue">:</span><span style="color: red">Name</span><span style="color: blue">=&quot;lb1&quot; </span><span style="color: red">Width</span><span style="color: blue">=&quot;200&quot; </span><span style="color: red">Height</span><span style="color: blue">=&quot;200&quot; </span><span style="color: red">SelectionMode</span><span style="color: blue">=&quot;Multiple&quot; </span><span style="color: red">SelectionChanged</span></font></font><font size="2"><font face="Consolas"><span style="color: blue">=&quot;lb1_SelectionChanged&quot;&gt;         <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">ListBoxItem</span></font></font><font size="2"><font face="Consolas"><span style="color: blue">&gt;         <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">Button</span><span style="color: blue">&gt;</span><span style="color: #a31515">Item1</span><span style="color: blue">&lt;/</span><span style="color: #a31515">Button</span></font></font><font size="2"><font face="Consolas"><span style="color: blue">&gt;         <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;/</span><span style="color: #a31515">ListBoxItem</span></font></font><font size="2"><font face="Consolas"><span style="color: blue">&gt;         <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">ListBoxItem</span><span style="color: blue">&gt;</span><span style="color: #a31515">Item5</span><span style="color: blue">&lt;/</span><span style="color: #a31515">ListBoxItem</span></font></font><font size="2"><font face="Consolas"><span style="color: blue">&gt;         <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">ListBoxItem</span><span style="color: blue">&gt;</span><span style="color: #a31515">Item3</span><span style="color: blue">&lt;/</span><span style="color: #a31515">ListBoxItem</span></font></font><font size="2"><font face="Consolas"><span style="color: blue">&gt;         <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">ListBoxItem</span><span style="color: blue">&gt;</span><span style="color: #a31515">Item2</span><span style="color: blue">&lt;/</span><span style="color: #a31515">ListBoxItem</span></font></font><font size="2"><font face="Consolas"><span style="color: blue">&gt;         <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;/</span><span style="color: #a31515">ListBox</span></font></font><font size="2"><font face="Consolas"><span style="color: blue">&gt;         <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">ListBox </span><span style="color: red">x</span><span style="color: blue">:</span><span style="color: red">Name</span><span style="color: blue">=&quot;lb2&quot; </span><span style="color: red">Width</span><span style="color: blue">=&quot;200&quot; </span><span style="color: red">Height</span></font></font><font size="2"><font face="Consolas"><span style="color: blue">=&quot;200&quot;         <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: red">ItemsSource</span><span style="color: blue">=&quot;{</span><span style="color: #a31515">Binding </span><span style="color: red">Selected</span></font></font><font size="2"><font face="Consolas"><span style="color: blue">}&quot;&gt;         <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;/</span><span style="color: #a31515">ListBox</span></font></font><font size="2"><font face="Consolas"><span style="color: blue">&gt;         <br />&lt;/</span><span style="color: #a31515">StackPanel</span><span style="color: blue">&gt;         <br /></span></font></font>    <br />Now inside the constructor of the Window which has the listboxes, set the DataContext for sp so that it knows where to look for Selected.     <br /><font size="2"><font face="Consolas"><span style="color: blue">         <br />public </span>Window1()        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; InitializeComponent();        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; sp.DataContext = <span style="color: blue">this</span>;        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Selected = <span style="color: blue">new </span><span style="color: #2b91af">List</span>&lt;<span style="color: blue">object</span>&gt;();        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }        <br /></font></font>    <br />Now in the SelectionChanged event of Lb1, you update the Selected property collection accordingly. The code which does just that is shown.     <br /><font size="2"><font face="Consolas"><span style="color: blue">         <br />private void </span>lb1_SelectionChanged(<span style="color: blue">object </span>sender, <span style="color: #2b91af">SelectionChangedEventArgs </span>e)        <br />&#160;&#160;&#160;&#160;&#160;&#160; {        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">IList </span>l = <span style="color: blue">new </span><span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">Object</span>&gt;();        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach </span>(<span style="color: blue">var </span>x <span style="color: blue">in </span>lb1.SelectedItems)        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; l.Add(Clone(x));        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Selected = l;        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font><font size="2"><font face="Consolas"><span style="color: green">//BindingOperations.GetBindingExpressionBase(lb2, ListBox.ItemsSourceProperty).UpdateTarget();         <br />&#160;&#160;&#160;&#160;&#160;&#160; </span>}        <br /></font></font>    <br />Again, another problem arises here. How do we clone WPF elements? The idea is to get XAML for the given WPF element, convert it back to object. Simply way to clone. The code for the function Clone() is shown.     <br /><font size="2"><font face="Consolas"><span style="color: blue">         <br />public </span><span style="color: #2b91af">Object </span>Clone(<span style="color: #2b91af">Object </span>o)         <br />{         <br />&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string </span>xamlCode = <span style="color: #2b91af">XamlWriter</span>.Save(o);         <br />&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return </span><span style="color: #2b91af">XamlReader</span>.Load(<span style="color: blue">new </span><span style="color: #2b91af">XmlTextReader</span>(<span style="color: blue">new </span><span style="color: #2b91af">StringReader</span>(xamlCode)));         <br />}        <br /></font></font>    <br />I posted solution for this problem at : <a title="http://social.msdn.microsoft.com/Forums/en-US/wpf/thread/3da8c3b9-0a91-49c6-a460-f9215a294f29" href="http://social.msdn.microsoft.com/Forums/en-US/wpf/thread/3da8c3b9-0a91-49c6-a460-f9215a294f29">http://social.msdn.microsoft.com/Forums/en-US/wpf/thread/3da8c3b9-0a91-49c6-a460-f9215a294f29</a>     <br />    <br />Just in case, here is the draft.     <br /><a href="http://11011.net/software/vspaste"></a></p>  
</div>


          <div class="footer">
            <div class="contact">
              <p>
                Your Name<br />
                What You Are<br />
                you@example.com
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/yourusername">github.com/yourusername</a><br />
                <a href="https://twitter.com/yourusername">twitter.com/yourusername</a><br />
              </p>
            </div>
          </div>
        </div>

    </body>
</html>
